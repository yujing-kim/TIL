# ê°œì¸ì´ DevOps ì‹œì‘í•˜ê¸°2

# ğŸ¤§ Vagrant ì˜ í•œê³„

## **ë³´ë‹¤ íš¨ìœ¨ì ìœ¼ë¡œ ì¸í”„ë¼ë¥¼ ê´€ë¦¬í•˜ê¸° ìœ„í•œ ê°œì„  ì‚¬í•­ (= vagrantì˜ í•œê³„)**

- êµ¬ì¶• ì ˆì°¨ë¥¼ ê¸°ìˆ í•˜ëŠ” ì‚¬ëŒì— ë”°ë¼ ë‹¤ì–‘
- êµ¬ì¶•ëœ í™˜ê²½ì— ëŒ€í•œ ì¶”ê°€ ì„¤ì •ì´ ë¶ˆê°€
- ë‹¤ì–‘í•œ í™˜ê²½ì— ì ìš©í•˜ê¸° ì–´ë µë‹¤

## ì¸í”„ë¼ êµ¬ì„± ê´€ë¦¬ ë„êµ¬ì˜ íŠ¹ì§•

- ì„ ì–¸ì 
- ì¶”ìƒí™”
- ìˆ˜ë ´í™”
- ë©±ë“±ì„±
- ê°„ì†Œí™”

# ğŸ§ Ansibleë¡œ ë²”ìš©ì ìœ¼ë¡œ êµ¬ì¶•í•˜ê³  ë‹¤ë¥¸ í™˜ê²½ìœ¼ë¡œ ì „ê°œ

## ì•¤ì„œë¸”(Ansible) ê¸°ë³¸ ì‚¬ìš©ë²•

- íŒŒì´ì¬ìœ¼ë¡œ ë§Œë“¤ì–´ì§„ ì¸í”„ë¼ êµ¬ì„± ê´€ë¦¬ ë„êµ¬

- ì•¤ì„œë¸” ë³¸ì²´
    - ì¸ë²¤í„°ë¦¬(inventory)
    - ëª¨ë“ˆ(module)

- í™˜ê²½ ì„¤ì • ë° êµ¬ì¶• ì ˆì°¨ë¥¼ í†µì¼ëœ í˜•ì‹ìœ¼ë¡œ ê¸°ìˆ 
- ë§¤ê°œ ë³€ìˆ˜ ë“± í™˜ê²½ì˜ ì°¨ì´ë¥¼ ê´€ë¦¬
- ì‹¤í–‰ ì „ì— ë³€ê²½ë˜ëŠ” ë¶€ë¶„ì„ íŒŒì•…

### #1 nginx ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸

```python
C:\HashiCorp\WorkDir> vagrant ssh

[vagrant@demo ~]$ systemctl status nginx
â— nginx.service - The nginx HTTP and reverse proxy server
Loaded: loaded (/usr/lib/systemd/system/nginx.service; disabled; vendor preset: disabled)
Active: active (running) since Thu 2020-09-10 00:38:06 UTC; 53min ago	â‡ ì„¤ì¹˜ë˜ì–´ ì‹¤í–‰ ì¤‘
Process: 3217 ExecStart=/usr/sbin/nginx (code=exited, status=0/SUCCESS)
Process: 3214 ExecStartPre=/usr/sbin/nginx -t (code=exited, status=0/SUCCESS)
Process: 3212 ExecStartPre=/usr/bin/rm -f /run/nginx.pid (code=exited, status=0/SUCCESS)
Main PID: 3219 (nginx)
CGroup: /system.slice/nginx.service
â”œâ”€3219 nginx: master process /usr/sbin/nginx
â”œâ”€3220 nginx: worker proces
â””â”€3221 nginx: worker process
```

### **#2 ansible ì„¤ì¹˜ ë° ë²„ì „ í™•ì¸**

```python
[vagrant@demo ~]$ sudo systemctl stop nginx.service

[vagrant@demo ~]$ sudo yum install -y epel-release

[vagrant@demo ~]$ sudo yum install -y ansible

[vagrant@demo ~]$ ansible --version
ansible 2.9.10
config file = /etc/ansible/ansible.cfg
configured module search path = [u'/home/vagrant/.ansible/plugins/modules', u'/usr/share/ansible/plugins/modules']
ansible python module location = /usr/lib/python2.7/site-packages/ansible
executable location = /usr/bin/ansible
python version = 2.7.5 (default, Apr  2 2020, 13:16:51) [GCC 4.8.5 20150623 (Red Hat 4.8.5-39)]
```

### #3 ansible ëª…ë ¹ìœ¼ë¡œ nginxë¥¼ ê¸°ë™

```python
[vagrant@demo ~]$ sudo sh -c "echo \"localhosts\" >> /etc/ansible/hosts"
[vagrant@demo ~]$ cat /etc/ansible/hosts
    .
    .
    .
    .
localhosts
```

- ì˜ë¯¸ ë¬¸ì = ë©”íƒ€ ë¬¸ì â‡’ ì–´ë–¤ ê¸°ëŠ¥ì—ì„œ íŠ¹ë³„í•œ ì˜ë¯¸ë¥¼ ê°€ì§€ëŠ” ë¬¸ì = íŠ¹ìˆ˜ ê¸°í˜¸

    â†’ SQL ë¬¸ì„ ì‘ì„±í•  ë•Œ í™‘ë”°ì›€í‘œ(')ëŠ” ë¬¸ìì—´ì˜ ì‹œì‘ê³¼ ëì„ ë‚˜íƒ€ë‚´ëŠ” ì˜ë¯¸ë¥¼ ê°€ì§„ ë¬¸ì

    â†’ URLì—ì„œ &ëŠ” ìš”ì²­ íŒŒë¼ë¯¸í„°ì™€ íŒŒë¼ë¯¸í„°ë¥¼ êµ¬ë¶„í•˜ëŠ” ì˜ë¯¸ë¥¼ ê°€ì§„ ë¬¸ì

- ì˜ë¯¸ ë¬¸ìë¥¼ ë¬¸ì ê·¸ ìì²´ë¡œ ì‚¬ìš©í•´ì•¼ í•  ê²½ìš°ê°€ ìˆë‹¤.
    - content ì»¬ëŸ¼ì— John's Name ì´ë¼ëŠ” ê¸€ìê°€ ë“¤ì–´ê°„ ê²ƒì„ ê²€ìƒ‰í•˜ëŠ” ì¿¼ë¦¬ë¥¼ ë§Œë“¤ ë•Œ

        â‡’ `content like '%John's Name%'`

    - ìš”ì²­ íŒŒë¼ë¯¸í„° ì¤‘ íŒŒë¼ë¯¸í„° ì´ë¦„ì´ CompanyNameì´ê³ , íŒŒë¼ë¯¸í„° ê°’ì´ Bandi & Luceì¸ ê²½ìš°

        â‡’ `â€¦?CompanyName=Bandi & Luce`

- ì˜ë¯¸ ë¬¸ìë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ë©´ í•´ì„ì„ í•  ìˆ˜ ì—†ê±°ë‚˜ ì˜ëª» í•´ì„í•´ì„œ ì˜¤ë¥˜ê°€ ë°œìƒ
- ì´ëŸ° ë¬¸ì œì ì„ í•´ê²°í•˜ê¸° ìœ„í•´ì„œëŠ” ì˜ë¯¸ ë¬¸ìë¥¼ ë¬¸ì ê·¸ ìì²´ë¡œ í•´ì„ë  ìˆ˜ ìˆë„ë¡ ë³€í˜•í•´ì•¼ í•œë‹¤.

- ì´ìŠ¤ì¼€ì´í”„ â‡’ ì˜ë¯¸ ë¬¸ìì—ì„œ ì˜ë¯¸ë¥¼ ì œê±°í•˜ê³  ë¬¸ìë§Œ ë‚¨ê¸°ëŠ” ê²ƒ
- ì´ìŠ¤ì¼€ì´í”„ë¥¼ êµ¬í˜„í•˜ëŠ” ë°©ë²•
    1. **ì´ìŠ¤ì¼€ì´í”„ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ì˜ë¯¸ ë¬¸ìë¥¼ ì‚¬ìš© â‡’ \ (ì—­ìŠ¬ë˜ì‰¬)** â‡’ `content like '%John\'s Name%'`
    2. í•´ë‹¹ ê¸°ëŠ¥ì—ì„œ ì œê³µí•´ ì£¼ëŠ” ê·œì¹™ì„ ì´ìš© â‡’ MySQLì¸ ê²½ìš° í™‘ë”°ì›€í‘œë¥¼ ë‘ ë²ˆ ì‚¬ìš© â‡’ `content like '%John''s Name%'`
    3. ì¼ì •í•œ ê·œì¹™ì— ë”°ë¼ì„œ ë³€ê²½í•´ì„œ ì´ìš© = ì¸ì½”ë”© â‡’ URLì˜ ê²½ìš° URL Encoding ê¸°ë²•ì„ ì´ìš©í•´ì„œ í‘œí˜„ â‡’ `CompanyName=Bandi %26 Luce`

- service start
    - [`localhost`](http://localhost) ëŠ” ì¸ë²¤í„°ë¦¬ íŒŒì¼ì— ê¸°ì¬ëœ ì„œë²„ ì¤‘ ì´ë²ˆ ëª…ë ¹ì–´ë¥¼ ìˆ˜í–‰í•  ëŒ€ìƒ
    - **`"changed": true`** ì¤‘ì§€ ìƒíƒœì—ì„œ ì‹¤í–‰ ìƒíƒœë¡œ ë³€ê²½
    - `-b`   ì›ê²© ì‹¤í–‰ë˜ëŠ” ëŒ€ìƒ ì„œë²„ì˜ ì‚¬ìš©ì(=root)
    - `-c local`  ëŒ€ìƒ ì„œë²„ê°€ ìê¸° ìì‹ ì´ë¸Œë¡œ SSHë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  localë¡œ ì—°ê²°
    - `-m service`   service ëª¨ë“ˆì„ ì´ìš©

```python
[vagrant@demo ~]$ ansible **localhost** -b -c local -m service -a "name=nginx state=started"
localhost | CHANGED => {
    **"changed": true,** 
    "name": "nginx", 
    "state": "started", 
    "status": {
        "ActiveEnterTimestampMonotonic": "0", 
        "ActiveExitTimestampMonotonic": "0", 
        "ActiveState": "inactive",
```

### #4 nginx ìƒíƒœ í™•ì¸

```python
[vagrant@demo ~]$ systemctl status nginx.service
â— nginx.service - The nginx HTTP and reverse proxy server
   Loaded: loaded (/usr/lib/systemd/system/nginx.service; disabled; vendor preset: disabled)
   Active: active (running) since Thu 2020-09-10 01:58:15 UTC; 7min ago
  Process: 25830 ExecStart=/usr/sbin/nginx (code=exited, status=0/SUCCESS)
  Process: 25828 ExecStartPre=/usr/sbin/nginx -t (code=exited, status=0/SUCCESS)
  Process: 25826 ExecStartPre=/usr/bin/rm -f /run/nginx.pid (code=exited, status=0/SUCCESS)
 Main PID: 25832 (nginx)
   CGroup: /system.slice/nginx.service
           â”œâ”€25832 nginx: master process /usr/sbin/nginx
           â”œâ”€25833 nginx: worker process
           â””â”€25834 nginx: worker process
```

### #5 nginxê°€ ì‹¤í–‰ ìƒíƒœì¼ ë•Œ ansible ëª…ë ¹(nginx ì„œë¹„ìŠ¤ë¥¼ ì‹œì‘)ë¥¼ ì‹¤í–‰

```python
[vagrant@demo ~]$ ansible localhost -b -c local -m service -a "name=nginx state=started"
localhost | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python"
    },
    **"changed": false,**		â‡ ì‹¤í–‰ ìƒíƒœì˜€ê¸° ë•Œë¬¸ì—, ìƒíƒœ ë³€í™”ê°€ ë°œìƒí•˜ì§€ ì•Šì•˜ìŒ 
    "name": "nginx",
    "state": "started",
    "status": {
        :
    }
}
```

---

## ansible ë” ì˜ ì‚¬ìš©í•˜ê¸° : ansible-playbook

### #1 git ì„¤ì¹˜

```python
[vagrant@demo ~]$ sudo yum install -y git
```

### #2 ansible-playbook-sample í´ë¡  ìƒì„±

```python
[vagrant@demo ~]$ git clone https://github.com/devops-book/ansible-playbook-sample.git
```

### #3 playbook ì‹¤í–‰í•´ì„œ êµ¬ì¶•

```python
[vagrant@demo ~]$ cd ansible-playbook-sample/
[vagrant@demo ansible-playbook-sample]$ ansible-playbook -i development site.yml                                                   
[WARNING]: Invalid characters were found in group names but not replaced, use -vvvv
to see details
PLAY [webservers] *******************************************************************

TASK [Gathering Facts] **************************************************************
ok: [localhost]

TASK [common : install epel] ********************************************************
ok: [localhost]			â‡ epel íŒ¨í‚¤ì§€ê°€ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆì–´ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•Šì•˜ë‹¤. 

TASK [install nginx] ****************************************************************
ok: [localhost]

TASK [nginx : replace index.html] ***************************************************
changed: [localhost]		â‡ TASK ì‹¤í–‰ ê²°ê³¼ê°€ ì˜ˆìƒí–ˆë˜ ë°ë¡œ ë³€ê²½ë˜ì—ˆë‹¤. 

TASK [nginx start] ******************************************************************
changed: [localhost]

PLAY RECAP **************************************************************************
localhost                  : ok=5    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

```

```python
[vagrant@demo ansible-playbook-sample]$ curl localhost
hello, development ansible		â‡ nginx í™ˆ ë””ë ‰í„°ë¦¬ì˜ index.html íŒŒì¼ì˜ ë‚´ìš©
```

- ë””ë ‰í„°ë¦¬ë¥¼ ë°”ê¾¸ì–´ ë³´ê¸°

```python
[vagrant@demo ansible-playbook-sample]$ ansible-playbook -i production site.yml
[WARNING]: Invalid characters were found in group names but not replaced, use -vvvv
to see details
PLAY [webservers] *******************************************************************

TASK [Gathering Facts] **************************************************************
ok: [localhost]

TASK [common : install epel] ********************************************************
ok: [localhost]

TASK [install nginx] ****************************************************************
ok: [localhost]

TASK [nginx : replace index.html] ***************************************************
changed: [localhost]

TASK [nginx start] ******************************************************************
ok: [localhost]

PLAY RECAP **************************************************************************
localhost                  : ok=5    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```

```python
[vagrant@demo ansible-playbook-sample]$ curl localhost
hello, production ansible
```

- site.yml íŒŒì¼ ì—´ì–´ë³´ê¸°
    - ì–´ë–¤ ì„œë²„ì—ì„œ ì–´ë–¤ ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” ë°©ë²•ì„ ì •ì˜í•˜ëŠ” ê²ƒì´ playbook íŒŒì¼ì…ë‹ˆë‹¤.
    - ì¼ë ¨ì˜ ì²˜ë¦¬ê°€ ëª¨ë‘ ê¸°ë¡ë˜ì–´ ìˆë‹¤.

```yaml
---
- hosts: webservers
  become: yes
  connection: local
  roles:
    - common
    - nginx
#    - serverspec
#    - serverspec_sample
#    - jenkins
```

### #4 ì‹¤í–‰ ëŒ€ìƒ ì •ì˜ë¥¼ í™•ì¸

- ì¸ë²¤í„°ë¦¬ íŒŒì¼ì€ /etc/ansible/hostsë¥¼ ì‚¬ìš©í•˜ì§€ë§Œ -i ì˜µì…˜ì„ ì´ìš©í•´ì„œ ì§€ì •í•  ìˆ˜ ë„ ìˆë‹¤

```python
[vagrant@demo ansible-playbook-sample]$ ls
development  group_vars  production  roles  site.yml	â‡ ì¸ë²¤í„°ë¦¬ íŒŒì¼
~~~~~~~~~~~              ~~~~~~~~~~
  
[vagrant@demo ansible-playbook-sample]$ cat development
[development-webservers]
localhost

[webservers:children]
development-webservers

[vagrant@demo ansible-playbook-sample]$ cat production
[production-webservers]
localhost

[webservers:children]
production-webservers
```

### #5 ì‹¤í–‰ ë‚´ìš© ì •ì˜ë¥¼ í™•ì¸

- ansible-playbook-sample/roles ë””ë ‰í„°ë¦¬ ì•„ë˜ì— tasks ë””ë ‰í„°ë¦¬ì— ê¸°ë¡

```python
[vagrant@demo ansible-playbook-sample]$ ls ./roles
common  jenkins  nginx  serverspec  serverspec_sample	â‡ ë¡¤ ë³„ë¡œ ì‹¤í–‰ë  ë‚´ìš©ì„ ë‹´ê³  ìˆëŠ” ë””ë ‰í„°ë¦¬

[vagrant@demo ansible-playbook-sample]$ ls ./roles/common/tasks/
main.yml							â‡ common ë¡¤ì—ì„œ ìˆ˜í–‰í•´ì•¼ í•  ë‚´ìš©ì„ ì •ì˜

[vagrant@demo ansible-playbook-sample]$ ls ./roles/nginx/tasks/
main.yml							â‡ nginx ë¡¤ì—ì„œ ìˆ˜í–‰í•´ì•¼ í•  ë‚´ìš©ì„ ì •ì˜

[vagrant@demo ansible-playbook-sample]$ cat ./roles/common/tasks/main.yml
---
# tasks file for common
- name: install epel
  yum: name=epel-release state=installed

[vagrant@demo ansible-playbook-sample]$ cat ./roles/nginx/tasks/main.yml
---
# tasks file for nginx
- name: install nginx
  yum: name=nginx state=installed

- name: replace index.html
  template: src=index.html.j2 dest=/usr/share/nginx/html/index.html

- name: nginx start
  service: name=nginx state=started enabled=yes
```

### #6 template í™•ì¸

```python
[vagrant@demo ansible-playbook-sample]$ ls ./roles/nginx/templates/
index.html.j2
[vagrant@demo ansible-playbook-sample]$ cat ./roles/nginx/templates/index.html.j2 
hello, {{ env }} ansible
```

### #7 í…œí”Œë¦¿ì—ì„œ ì‚¬ìš©í•˜ëŠ” ë³€ìˆ˜ ê°’ì„ í™•ì¸

- í…œí”Œë¦¿ì—ì„œ ì‚¬ìš©í•˜ëŠ” ë³€ìˆ˜ ê°’ì€ group_vars ë””ë ‰í„°ë¦¬ì— ê·¸ë£¹ë³„ë¡œ ì •ì˜

```python
[vagrant@demo ansible-playbook-sample]$ ls ./group_vars/
development-webservers.yml  production-webservers.yml

[vagrant@demo ansible-playbook-sample]$ cat ./group_vars/development-webservers.yml
env: "development"

[vagrant@demo ansible-playbook-sample]$ cat ./group_vars/production-webservers.yml
env: "production"
```

### #8 í…œí”Œë¦¿ ë‚´ìš©ì„ ë³€ê²½

```python
[vagrant@demo ansible-playbook-sample]$ vi ./roles/nginx/templates/index.html.j2
HELLO, {{ env }} ansible !!!				â‡ í…œí”Œë¦¿ ë‚´ìš© ë³€ê²½
```

### #9 dry-run ëª¨ë“œë¡œ ì‹¤í–‰

- `â€”check`ì˜µì…˜ : dry-run ëª¨ë“œë¡œ ì‹¤í–‰
- `â€”diff` ì˜µì…˜ : ë³€ê²½ ì°¨ì´ë¥¼ í‘œì‹œí•œë‹¤.

```python
[vagrant@demo ansible-playbook-sample]$ ansible-playbook -i development site.yml --check --diff
```

```python
-> ê²°ê³¼ì˜ ì¼ë¶€

TASK [nginx : replace index.html] **********************************************
--- before: /usr/share/nginx/html/index.html
+++ after: /home/vagrant/.ansible/tmp/ansible-local-267130NhB93/tmph_KXYZ/index.html.j2
@@ -1 +1 @@
-hello, production ansible
+HELLO, development ansible !!!

changed: [localhost]
```

- ë°˜ì˜ì´ ë˜ì§€ ì•Šì€ ìƒíƒœì—ì„œ ì‹¤í–‰í•˜ëŠ” ê²½ìš°
    - ì´ì „ ìƒíƒœë¡œ ì‹¤í–‰ì´ ëœë‹¤.

```python
[vagrant@demo ansible-playbook-sample]$ curl localhost
hello, production ansible
```

### #10 ë³€ê²½ ì‚¬í•­ì„ í˜¸ìŠ¤íŠ¸ì— ë°˜ì˜í•˜ê¸°

```python
[vagrant@demo ansible-playbook-sample]$ ansible-playbook -i development site.yml --diff

[vagrant@demo ansible-playbook-sample]$ curl localhost
HELLO, development ansible !!!
```

---

# ğŸ¤“  ì¸í”„ë¼ êµ¬ì„± ê´€ë¦¬ ë„êµ¬ê°€ ê°€ì ¸ë‹¤ ì£¼ëŠ” ê²ƒ

- vagrantë¥¼ ì‚¬ìš©í•¨ìœ¼ë¡œì¨ ìƒê²¼ë˜ ë¬¸ì œì— ëŒ€í•´ Ansibleì„ í™œìš© í•¨ìœ¼ë¡œì¨ ëŒ€ì‘í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

1. êµ¬ì¶• ì ˆì°¨ë¥¼ ì´í•´í•˜ê¸° ì–´ë µë‹¤.
    - Ansibleì˜ ì„ ì–¸ì ì¸ ê¸°ìˆ  ë°©ë²•ì— ì˜í•´ ìƒíƒœê°€ 'ìˆ˜ë ´í™”'ë˜ë„ë¡ ê¸°ì¬í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤. ì¦‰, ì ˆì°¨ê°€ ì•„ë‹Œ ê²°ê³¼ë§Œì„ ë³´ëŠ” ê²ƒì´ ê°€ëŠ¥í•´ì¡ŒìŠµë‹ˆë‹¤.
2. ì„¤ì •ì„ ì¶”ê°€í•  ìˆ˜ ì—†ë‹¤.
    - ì „ì œê°€ ë˜ëŠ” í™˜ê²½ ì¡°ê±´ì„ ê±±ì •í•  í•„ìš”ê°€ ì—†ìœ¼ë©°, ì„¤ì •ì˜ ì¶”ê°€ë„ ë„êµ¬ì—ê²Œ ë§¡ê¸°ë©° ê¸°ì¬ë§Œ í•˜ë©´ í•´ê²°ë©ë‹ˆë‹¤.
3. êµ¬ì¶• ì ˆì°¨ë¥¼ ë‹¤ë¥¸ í™˜ê²½ì—ì„œ ìœ ìš©í•˜ê¸° ì–´ë µë‹¤.
    - OS ë“±ì˜ í™˜ê²½ ì¡°ê±´ì„ ê±±ì •í•˜ê¸° ì•Šê³  êµ¬ì¶•ìœ¼ë¡œ ì¸í•´ ë‚˜íƒ€ë‚˜ëŠ” ìƒíƒœë§Œì„ ê°„ë‹¨í•˜ê²Œ ì´í•´í•  ìˆ˜ ìˆê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.

---

# ğŸ¤­ Serverspec ìœ¼ë¡œ ì¸í”„ë¼ êµ¬ì¶• í…ŒìŠ¤íŠ¸ ì½”ë“œí™”(ìë™í™”)

## #1 rvm ë° ruby ì„¤ì¹˜

- rvm ì„¤ì¹˜ ì „ ì„¤ì •

```python
[vagrant@demo ansible-playbook-sample]$ command curl -sSL https://rvm.io/mpapis.asc | sudo gpg2 --import -
gpg: directory `/root/.gnupg' created
gpg: new configuration file `/root/.gnupg/gpg.conf' created
gpg: WARNING: options in `/root/.gnupg/gpg.conf' are not yet active during this run
gpg: keyring `/root/.gnupg/secring.gpg' created
gpg: keyring `/root/.gnupg/pubring.gpg' created
gpg: /root/.gnupg/trustdb.gpg: trustdb created
gpg: key D39DC0E3: public key "Michal Papis (RVM signing) <mpapis@gmail.com>" imported
gpg: Total number processed: 1
gpg:               imported: 1  (RSA: 1)
gpg: no ultimately trusted keys found
```

```python
[vagrant@demo ansible-playbook-sample]$ command curl -sSL https://rvm.io/pkuczynski.asc | sudo gpg2
 --import -
gpg: key 39499BDB: public key "Piotr Kuczynski <piotr.kuczynski@gmail.com>" imported
gpg: Total number processed: 1
gpg:               imported: 1  (RSA: 1)
```

```python
[vagrant@demo ansible-playbook-sample]$ curl -L get.rvm.io | sudo bash -s stable
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   194  100   194    0     0    340      0 --:--:-- --:--:-- --:--:--   340
100 24535  100 24535    0     0  10527      0  0:00:02  0:00:02 --:--:-- 16488
Downloading https://github.com/rvm/rvm/archive/1.29.10.tar.gz
Downloading https://github.com/rvm/rvm/releases/download/1.29.10/1.29.10.tar.gz.asc
gpg: Signature made Wed 25 Mar 2020 09:58:42 PM UTC using RSA key ID 39499BDB
gpg: Good signature from "Piotr Kuczynski <piotr.kuczynski@gmail.com>"
...
```

```python
[vagrant@demo ansible-playbook-sample]$ sudo usermod -aG rvm $USER

[vagrant@demo ansible-playbook-sample]$ id $USER
uid=1000(vagrant) gid=1000(vagrant) groups=1000(vagrant),1001(rvm)

[vagrant@demo ansible-playbook-sample]$ source /etc/profile.d/rvm.sh

[vagrant@demo ansible-playbook-sample]$ rvm reload
RVM reloaded!

[vagrant@demo ansible-playbook-sample]$ sudo su

[root@demo ansible-playbook-sample]# rvm requirements run
Checking requirements for centos.
Installing requirements for centos.
Installing required packages: bison, libffi-devel, readline-devel, sqlite-devel, zlib-devel, openssl-devel............
Requirements installation successful.
```

- rvmìœ¼ë¡œ ë£¨ë¹„ ì„¤ì¹˜

    â†’ rvm? : ruby version manager : ë£¨ë¹„ë¥¼ ê´€ë¦¬í•˜ëŠ” ë§¤ë‹ˆì €

```python
[root@demo ansible-playbook-sample]# rvm install 2.7
Searching for binary rubies, this might take some time.
Found remote file https://rvm_io.global.ssl.fastly.net/binaries/centos/7/x86_64/ruby-2.7.0.tar.bz2
Checking requirements for centos.
Requirements installation successful.
ruby-2.7.0 - #configure
ruby-2.7.0 - #download
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 18.3M  100 18.3M    0     0  3388k      0  0:00:05  0:00:05 --:--:-- 3859k
No checksum for downloaded archive, recording checksum in user configuration.
ruby-2.7.0 - #validate archive
ruby-2.7.0 - #extract
ruby-2.7.0 - #validate binary
ruby-2.7.0 - #setup
ruby-2.7.0 - #gemset created /usr/local/rvm/gems/ruby-2.7.0@global
ruby-2.7.0 - #importing gemset /usr/local/rvm/gemsets/global.gems...............
ruby-2.7.0 - #generating global wrappers.......
ruby-2.7.0 - #gemset created /usr/local/rvm/gems/ruby-2.7.0
ruby-2.7.0 - #importing gemsetfile /usr/local/rvm/gemsets/default.gems evaluated to empty gem list
ruby-2.7.0 - #generating default wrappers.......
```

- rvm ì„¤ì¹˜ í™•ì¸

    â†’ rootì—ì„œ 2.7ë¡œ ì„¤ì¹˜(ê³ ì •)

    â†’ rootì—ì„œ ë‚˜ê°„ë‹¤ (vagrantë¡œ)

```coffeescript
[root@demo ansible-playbook-sample]# rvm use 2.7 --default
Using /usr/local/rvm/gems/ruby-2.7.0
[root@demo ansible-playbook-sample]# rvm list
=* ruby-2.7.0 [ x86_64 ]

# => - current
# =* - current && default
#  * - default

[root@demo ansible-playbook-sample]# exit
exit
```

- ruby ì„¤ì¹˜

```coffeescript
[vagrant@demo ansible-playbook-sample]$ ruby -v
ruby 2.0.0p648 (2015-12-16) [x86_64-linux]

-> ë²„ì „ì„ 2.7ë¡œ ê³ ì •
[vagrant@demo ansible-playbook-sample]$ rvm use 2.7 --default
Using /usr/local/rvm/gems/ruby-2.7.0

[vagrant@demo ansible-playbook-sample]$ ruby -v
ruby 2.7.0p0 (2019-12-25 revision 647ee6f091) [x86_64-linux]
```

- ruby ì„¤ì •

```coffeescript
[vagrant@demo ansible-playbook-sample]$ which ruby
/usr/local/rvm/rubies/ruby-2.7.0/bin/ruby

[vagrant@demo ansible-playbook-sample]$ sudo which ruby
/bin/ruby

[vagrant@demo ansible-playbook-sample]$ sudo mv /bin/ruby /bin/ruby_2.0.0

[vagrant@demo ansible-playbook-sample]$ sudo ln -s /usr/local/rvm/rubies/ruby-2.7.0/bin/ruby /bin/ruby

[vagrant@demo ansible-playbook-sample]$ ruby -v
ruby 2.7.0p0 (2019-12-25 revision 647ee6f091) [x86_64-linux]

[vagrant@demo ansible-playbook-sample]$ sudo ruby -v
ruby 2.7.0p0 (2019-12-25 revision 647ee6f091) [x86_64-linux]
```

## #2 Playbook íŒŒì¼ (site.yaml)ì—ì„œ serverspec ë¡¤ì„ ì¶”ê°€

```python
[vagrant@demo ansible-playbook-sample]$ vi site.yml
```

```yaml
---
- hosts: webservers
  become: yes
  connection: local
  roles:
    - common
    - nginx
    - serverspec
#    - serverspec_sample
#    - jenkins
```

## #3 sercerspec ë¡¤ì„ í™•ì¸

```python
[vagrant@demo ansible-playbook-sample]$ cat ./roles/serverspec/tasks/main.yml
---
# tasks file for serverspec
- name: install ruby
  yum: name=ruby state=installed

- name: install serverspec
  gem: name={{ item }} state=present user_install=no
  with_items:
   - rake
   - serverspec
```

## #4 ansible-playbookìœ¼ë¡œ Serverspec ì„¤ì¹˜

```coffeescript
[vagrant@demo ansible-playbook-sample]$ ansible-playbook -i development site.yml --diff
[WARNING]: Invalid characters were found in group names but not replaced, use -vvvv to see details

PLAY [webservers] ***********************************************************************************************

TASK [Gathering Facts] ******************************************************************************************
ok: [localhost]

TASK [common : install epel] ************************************************************************************
ok: [localhost]

TASK [install nginx] ********************************************************************************************
ok: [localhost]

TASK [nginx : replace index.html] *******************************************************************************
ok: [localhost]

TASK [nginx start] **********************************************************************************************
ok: [localhost]

TASK [serverspec : install ruby] ********************************************************************************
ok: [localhost]

TASK [install serverspec] ***************************************************************************************
ok: [localhost] => (item=rake)
changed: [localhost] => (item=serverspec)

PLAY RECAP ******************************************************************************************************
localhost                  : ok=7    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```

## #5 Serverspec ì´ˆê¸° ì„¤ì •

```coffeescript
[vagrant@demo ~]$ mkdir ~/serverspec && cd ~/serverspec
```

```coffeescript
[vagrant@demo serverspec]$ serverspec-init
Select OS type:

  1) UN*X
  2) Windows

Select number: 1

Select a backend type:

  1) SSH
  2) Exec (local)

Select number: 2

 + spec/
 + spec/localhost/
 + spec/localhost/sample_spec.rb
 + spec/spec_helper.rb
 + Rakefile
 + .rspec
```

## #6 sample_spec.rb íŒŒì¼ì„ í™•ì¸

```coffeescript
[vagrant@demo ansible-playbook-sample]$ cat ./spec/localhost/sample_spec.rb
require 'spec_helper'

describe package('httpd'), :if => os[:family] == 'redhat' do
  it { should be_installed }		â‡ httpdê°€ ì„¤ì¹˜ë˜ì–´ ìˆì–´ì•¼ í•œë‹¤.
end
		:
describe service('httpd'), :if => os[:family] == 'redhat' do
  it { should be_enabled }		â‡ httpd ì„œë¹„ìŠ¤ê°€ í™œì„±í™”ë˜ì–´ ìˆì–´ì•¼ í•œë‹¤.
  it { should be_running }		â‡ httpd ì„œë¹„ìŠ¤ê°€ ì‹¤í–‰ë˜ê³  ìˆì–´ì•¼ í•œë‹¤. 
end
		:
describe port(80) do
  it { should be_listening }  â‡ 80 í¬íŠ¸ê°€ ë™ì‘(listen)í•˜ê³  ìˆì–´ì•¼ í•œë‹¤.
end
```

## #7 Serverspecì„ ì´ìš©í•œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰

```arduino
[vagrant@demo serverspec]$ rake spec
/usr/local/rvm/rubies/ruby-2.7.0/bin/ruby -I/usr/local/rvm/rubies/ruby-2.7.0/lib/ruby/gems/2.7.0/gems/rspec-support-3.9.3/lib:/usr/local/rvm/rubies/ruby-2.7.0/lib/ruby/gems/2.7.0/gems/rspec-core-3.9.2/lib /usr/local/rvm/rubies/ruby-2.7.0/lib/ruby/gems/2.7.0/gems/rspec-core-3.9.2/exe/rspec --pattern spec/localhost/\*_spec.rb

Package "httpd"
  is expected to be installed (FAILED - 1)

Service "httpd"
  is expected to be enabled (FAILED - 2)
  is expected to be running (FAILED - 3)

Port "80"
  is expected to be listening

Failures:

  1) Package "httpd" is expected to be installed
     On host `localhost'
     Failure/Error: it { should be_installed }
       expected Package "httpd" to be installed
       /bin/sh -c rpm\ -q\ httpd
       package httpd is not installed

     # ./spec/localhost/sample_spec.rb:4:in `block (2 levels) in <top (required)>'

  2) Service "httpd" is expected to be enabled
     On host `localhost'
     Failure/Error: it { should be_enabled }
       expected Service "httpd" to be enabled
       /bin/sh -c systemctl\ --quiet\ is-enabled\ httpd
       
     # ./spec/localhost/sample_spec.rb:12:in `block (2 levels) in <top (required)>'

  3) Service "httpd" is expected to be running
     On host `localhost'
     Failure/Error: it { should be_running }
       expected Service "httpd" to be running
       /bin/sh -c systemctl\ is-active\ httpd
       unknown

     # ./spec/localhost/sample_spec.rb:13:in `block (2 levels) in <top (required)>'

Finished in 0.12785 seconds (files took 0.64409 seconds to load)
4 examples, 3 failures   â‡ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½

Failed examples:         â‡ ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ëª©ë¡

rspec ./spec/localhost/sample_spec.rb:4 # Package "httpd" is expected to be installed
rspec ./spec/localhost/sample_spec.rb:12 # Service "httpd" is expected to be enabled
rspec ./spec/localhost/sample_spec.rb:13 # Service "httpd" is expected to be running

/usr/local/rvm/rubies/ruby-2.7.0/bin/ruby -I/usr/local/rvm/rubies/ruby-2.7.0/lib/ruby/gems/2.7.0/gems/rspec-support-3.9.3/lib:/usr/local/rvm/rubies/ruby-2.7.0/lib/ruby/gems/2.7.0/gems/rspec-core-3.9.2/lib /usr/local/rvm/rubies/ruby-2.7.0/lib/ruby/gems/2.7.0/gems/rspec-core-3.9.2/exe/rspec --pattern spec/localhost/\*_spec.rb failed
```

- ì‹¤íŒ¨ê°€ ë‚˜ëŠ” ë¶€ë¶„ì€ site.yml íŒŒì¼ì— serverspec_sampleì´ ì—†ê¸°ë•Œë¬¸!

---

# Ansible ì´ìš©í•´ì„œ Serverpecì˜ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤(_sepc.rb) ìë™ ìƒì„±

## #1 PlaybookíŒŒì¼(site.yml)ì— serverspec_sample ë¡¤(role) ì¶”ê°€

- `serverspec_sample` ë¶€ë¶„ì˜ ì£¼ì„ì„ ì œê±°í•œë‹¤.

```arduino
[vagrant@demo ~]$ cat ansible-playbook-sample/site.yml 
---
- hosts: webservers
  become: yes
  connection: local
  roles:
    - common
    - nginx
    - serverspec
    - serverspec_sample
#    - jenkins
```

## **#3 serverspec_sample ë¡¤ ì •ì˜ íŒŒì¼ì„ í™•ì¸**

```arduino
[vagrant@demo ansible-playbook-sample]$ cat ./roles/serverspec_sample/tasks/main.yml
- --
# tasks file for serverspec_sample
- name: distribute serverspec suite
copy: src=serverspec_sample dest={{ serverspec_base_path }} â‡ /tmp ì•„ë˜ë¡œ serverspec_sample ë””ë ‰í„°ë¦¬ë¥¼ ë³µì‚¬
- name: distribute spec file
template: src=web_spec.rb.j2 dest={{ serverspec_path }}/spec/localhost/web_spec.rb
																													â‡ í…œí”Œë¦¿ì— ì •ì˜ëœ ë‚´ìš©ìœ¼ë¡œ web_spec.rb íŒŒì¼ì„ ìƒì„±
```

```arduino
[vagrant@demo ansible-playbook-sample]$ cat ./roles/serverspec_sample/vars/main.yml	
â‡ taskì—ì„œ ì‚¬ìš©í•˜ëŠ” ë³€ìˆ˜ë¥¼ ì •ì˜
serverspec_base_path: "/tmp"									   
serverspec_path: "{{ serverspec_base_path }}/serverspec_sample"
```

- ì‹¤í—˜í•  test caseë¥¼ ë§Œë“¤ì–´ ë†“ìŒ

```arduino
																																				â‡ serverspecì—ì„œ ì‚¬ìš©í•  í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ í…œí”Œë¦¿
[vagrant@demo ansible-playbook-sample]$ cat ./roles/serverspec_sample/templates/web_spec.rb.j2
require 'spec_helper'

describe package('nginx') do      â‡ nginx ì„¤ì¹˜ ì—¬ë¶€
  it { should be_installed }
end

describe service('nginx') do      â‡ nginx ì‹¤í–‰/í™œì„±í™” ì—¬ë¶€
  it { should be_enabled }
  it { should be_running }
end

describe port(80) do              â‡ 80 í¬íŠ¸ í™•ì¸
  it { should be_listening }
end

describe file('/usr/share/nginx/html/index.html') do
  it { should be_file }           â‡ index.html íŒŒì¼ ì¡´ì¬ ì—¬ë¶€
  it { should exist }
  its(:content) { should match /^Hello, {{ env }} ansible!!$/ } â‡ index.html íŒŒì¼ì˜ ë‚´ìš© ê²€ì¦
end
```

## #3 Ansible ëª…ë ¹ìœ¼ë¡œ spec íŒŒì¼ì˜ ë°°í¬

```arduino
[vagrant@demo ~]$ cd ~/ansible-playbook-sample/
[vagrant@demo ansible-playbook-sample]$ ansible-playbook -i development site.yml 
[WARNING]: Invalid characters were found in group names but not replaced, use -vvvv to see details

PLAY [webservers] ***********************************************************************************************

TASK [Gathering Facts] ******************************************************************************************
ok: [localhost]

TASK [common : install epel] ************************************************************************************
ok: [localhost]

TASK [install nginx] ********************************************************************************************
ok: [localhost]

TASK [nginx : replace index.html] *******************************************************************************
ok: [localhost]

TASK [nginx start] **********************************************************************************************
ok: [localhost]

TASK [serverspec : install ruby] ********************************************************************************
ok: [localhost]

TASK [install serverspec] ***************************************************************************************
ok: [localhost] => (item=rake)
ok: [localhost] => (item=serverspec)

TASK [serverspec_sample : distribute serverspec suite] **********************************************************
changed: [localhost]        â‡ /tmp ë””ë ‰í„°ë¦¬ ì•„ë˜ë¡œ serverspec_sample ë””ë ‰í„°ë¦¬ë¥¼ ë³µì‚¬
															/tmp/serverspec_sample ë””ë ‰í„°ë¦¬ëŠ” ì¸í”„ë¼ê°€ ì›í•˜ëŠ” í˜•íƒœë¡œ êµ¬ì„±ë˜ì—ˆëŠ”ì§€ í…ŒìŠ¤íŠ¸í•˜ëŠ” ê³µê°„

TASK [serverspec_sample : distribute spec file] *****************************************************************
changed: [localhost]         â‡ í…œí”Œë¦¿ì„ ì´ìš©í•´ì„œ web_spec.rb íŒŒì¼ì„ ì •ìƒì ìœ¼ë¡œ ìƒì„±

PLAY RECAP ******************************************************************************************************
localhost                  : ok=9    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```

## #4 spec íŒŒì¼(test caseë¥¼ ì •ì˜) ìƒì„±ì„ í™•ì¸

```arduino
[vagrant@demo ansible-playbook-sample]$ cat /tmp/serverspec_sample/spec/localhost/web_spec.rb 
require 'spec_helper'

describe package('nginx') do
  it { should be_installed }
end

describe service('nginx') do
  it { should be_enabled }
  it { should be_running }
end

describe port(80) do
  it { should be_listening }
end

describe file('/usr/share/nginx/html/index.html') do
  it { should be_file }
  it { should exist }
  its(:content) { should match /^Hello, development ansible!!$/ }
end
```

## #5 (ansibleìœ¼ë¡œ ìë™ ìƒì„±í•œ) spec íŒŒì¼ì„ ì´ìš©í•´ì„œ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰

- ìš°ë¦¬ê°€ ë§Œë“  contentì™€ test caseì˜ ì¶©ëŒì´ ìƒê¸´ë‹¤!

```arduino
[vagrant@demo ansible-playbook-sample]$ cd /tmp/serverspec_sample/   â‡ ì‘ì—… ë””ë ‰í„°ë¦¬(í…ŒìŠ¤íŠ¸ ë””ë ‰í„°ë¦¬)ë¡œ ì´ë™
[vagrant@demo serverspec_sample]$ rake spec        â‡ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
/usr/local/rvm/rubies/ruby-2.7.0/bin/ruby -I/usr/local/rvm/rubies/ruby-2.7.0/lib/ruby/gems/2.7.0/gems/rspec-support-3.9.3
/lib:/usr/local/rvm/rubies/ruby-2.7.0/lib/ruby/gems/2.7.0/gems/rspec-core-3.9.2/lib /usr/local/rvm/rubies/ruby-2.7.0/lib
/ruby/gems/2.7.0/gems/rspec-core-3.9.2/exe/rspec --pattern spec/localhost/\*_spec.rb

Package "nginx"
  is expected to be installed

Service "nginx"
  is expected to be enabled
  is expected to be running

Port "80"
  is expected to be listening

File "/usr/share/nginx/html/index.html"
  is expected to be file
  is expected to exist
  content
    is expected to match /^Hello, development ansible!!$/ (FAILED - 1)  
          â‡ nginxì˜ index.html íŒŒì¼ ë‚´ìš©ì´ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ì— ëª…ì‹±ëœ ë‚´ìš©ê³¼ ë‹¤ë¥´ê¸° ë•Œë¬¸ì— í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ê°€ ë°œìƒ

Failures:

  1) File "/usr/share/nginx/html/index.html" content is expected to match /^Hello, development ansible!!$/
     On host `localhost'
     Failure/Error: its(:content) { should match /^Hello, development ansible!!$/ }
       expected "HELLO, development ansible !!!\n" to match /^Hello, development ansible!!$/
       Diff:
       @@ -1 +1 @@
       -/^Hello, development ansible!!$/
       +HELLO, development ansible !!!
       
       /bin/sh -c cat\ /usr/share/nginx/html/index.html\ 2\>\ /dev/null\ \|\|\ echo\ -n
       HELLO, development ansible !!!

     # ./spec/localhost/web_spec.rb:19:in `block (2 levels) in <top (required)>'

Finished in 0.15082 seconds (files took 0.61144 seconds to load)
7 examples, 1 failure

Failed examples:

rspec ./spec/localhost/web_spec.rb:19 # File "/usr/share/nginx/html/index.html" content is expected to match /^Hello, development ansible!!$/

/usr/local/rvm/rubies/ruby-2.7.0/bin/ruby -I/usr/local/rvm/rubies/ruby-2.7.0/lib/ruby/gems/2.7.0/gems/rspec-support-3.9.3/lib:/usr/local/rvm/rubies/ruby-2.7.0/lib/ruby/gems/2.7.0/gems/rspec-core-3.9.2/lib /usr/local/rvm/rubies/ruby-2.7.0/lib/ruby/gems/2.7.0/gems/rspec-core-3.9.2/exe/rspec --pattern spec/localhost/\*_spec.rb failed
```

## #6 í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ í†µê³¼í•˜ë„ë¡ ì»¨í…ì¸ ë¥¼ ìˆ˜ì •

â†’ ì»¨í…ì¸  í˜•ì‹ì„ ì •ì˜í•˜ê³  ìˆëŠ” í…œí”Œë¦¿ íŒŒì¼ì„ ìˆ˜ì •

```arduino
[vagrant@demo ansible-playbook-sample]$ cat ~/ansible-playbook-sample/roles/nginx/templates/index.html.j2
HELLO, {{ env }} ansible !!!     â‡ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ì™€ ìƒì´ â†’ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ì— ë§ì¶°ì„œ ìˆ˜ì •

[vagrant@demo ansible-playbook-sample]$ vi ~/ansible-playbook-sample/roles/nginx/templates/index.html.j2
Hello, {{ env }} ansible!!
```

## #7 ansible-playbookìœ¼ë¡œ ë°°í¬ í›„ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰

- ë°”ë€ ë¶€ë¶„ì„ ë°°í¬ â†’ ìˆ˜ì •í•œ í…œí”Œë¦¿ì— ë§ì¶°ì„œ ìƒˆë¡­ê²Œ index.htmlì„ ìƒì„±

```arduino
[vagrant@demo ansible-playbook-sample]$ ansible-playbook -i development site.yml 
[WARNING]: Invalid characters were found in group names but not replaced, use -vvvv to see details

PLAY [webservers] ***********************************************************************************************

TASK [Gathering Facts] ******************************************************************************************
ok: [localhost]

TASK [common : install epel] ************************************************************************************
ok: [localhost]

TASK [install nginx] ********************************************************************************************
ok: [localhost]

TASK [nginx : replace index.html] *******************************************************************************
changed: [localhost]

TASK [nginx start] **********************************************************************************************
ok: [localhost]

TASK [serverspec : install ruby] ********************************************************************************
ok: [localhost]

TASK [install serverspec] ***************************************************************************************
ok: [localhost] => (item=rake)
ok: [localhost] => (item=serverspec)

TASK [serverspec_sample : distribute serverspec suite] **********************************************************
ok: [localhost]

TASK [serverspec_sample : distribute spec file] *****************************************************************
ok: [localhost]

PLAY RECAP ******************************************************************************************************
localhost                  : ok=9    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```

## #8  í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰

```arduino
[vagrant@demo ansible-playbook-sample]$ cd /tmp/serverspec_sample/
[vagrant@demo serverspec_sample]$ rake spec
/usr/local/rvm/rubies/ruby-2.7.0/bin/ruby -I/usr/local/rvm/rubies/ruby-2.7.0/lib/ruby/gems/2.7.0/gems/rspec-support-3.9.3/lib:/usr/local/rvm/rubies/ruby-2.7.0/lib/ruby/gems/2.7.0/gems/rspec-core-3.9.2/lib /usr/local/rvm/rubies/ruby-2.7.0/lib/ruby/gems/2.7.0/gems/rspec-core-3.9.2/exe/rspec --pattern spec/localhost/\*_spec.rb

Package "nginx"
  is expected to be installed

Service "nginx"
  is expected to be enabled
  is expected to be running

Port "80"
  is expected to be listening

File "/usr/share/nginx/html/index.html"
  is expected to be file
  is expected to exist
  content
    is expected to match /^Hello, development ansible!!$/

Finished in 0.13465 seconds (files took 0.59507 seconds to load)
7 examples, 0 failures           â‡ 7ê°œ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ ëª¨ë‘ í†µê³¼
```

## #9 nginxë¥¼ ì¤‘ì§€ í›„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰

```arduino
[vagrant@demo serverspec_sample]$ sudo systemctl stop nginx.service
[vagrant@demo serverspec_sample]$ systemctl status nginx.service
â— nginx.service - The nginx HTTP and reverse proxy server
   Loaded: loaded (/usr/lib/systemd/system/nginx.service; enabled; vendor preset: disabled)
   Active: inactive (dead) since Thu 2020-09-10 08:12:51 UTC; 46s ago
 Main PID: 25911 (code=exited, status=0/SUCCESS)
```

- í…ŒìŠ¤íŠ¸ ì‹¤í–‰

```arduino
[vagrant@demo serverspec_sample]$ rake spec
/usr/local/rvm/rubies/ruby-2.7.0/bin/ruby -I/usr/local/rvm/rubies/ruby-2.7.0/lib/ruby/gems/2.7.0/gems/rspec-support-3.9.3/lib:/usr/local/rvm/rubies/ruby-2.7.0/lib/ruby/gems/2.7.0/gems/rspec-core-3.9.2/lib /usr/local/rvm/rubies/ruby-2.7.0/lib/ruby/gems/2.7.0/gems/rspec-core-3.9.2/exe/rspec --pattern spec/localhost/\*_spec.rb

Package "nginx"
  is expected to be installed

Service "nginx"
  is expected to be enabled
  is expected to be running (FAILED - 1)

Port "80"
  is expected to be listening (FAILED - 2)

File "/usr/share/nginx/html/index.html"
  is expected to be file
  is expected to exist
  content
    is expected to match /^Hello, development ansible!!$/

Failures:

  1) Service "nginx" is expected to be running
     On host `localhost'
     Failure/Error: it { should be_running }
       expected Service "nginx" to be running
       /bin/sh -c systemctl\ is-active\ nginx
       inactive

     # ./spec/localhost/web_spec.rb:9:in `block (2 levels) in <top (required)>'

  2) Port "80" is expected to be listening
     On host `localhost'
     Failure/Error: it { should be_listening }
       expected Port "80" to be listening
       /bin/sh -c ss\ -tunl\ \|\ grep\ -E\ --\ :80\\\ 
       
     # ./spec/localhost/web_spec.rb:13:in `block (2 levels) in <top (required)>'

Finished in 0.15061 seconds (files took 0.59617 seconds to load)
7 examples, 2 failures

Failed examples:

rspec ./spec/localhost/web_spec.rb:9 # Service "nginx" is expected to be running
rspec ./spec/localhost/web_spec.rb:13 # Port "80" is expected to be listening

/usr/local/rvm/rubies/ruby-2.7.0/bin/ruby -I/usr/local/rvm/rubies/ruby-2.7.0/lib/ruby/gems/2.7.0/gems/rspec-support-3.9.3/lib:/usr/local/rvm/rubies/ruby-2.7.0/lib/ruby/gems/2.7.0/gems/rspec-core-3.9.2/lib /usr/local/rvm/rubies/ruby-2.7.0/lib/ruby/gems/2.7.0/gems/rspec-core-3.9.2/exe/rspec --pattern spec/localhost/\*_spec.rb failed
```

## #10 í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ HTML í˜•ì‹ìœ¼ë¡œ ì¶œë ¥

```arduino
[vagrant@demo serverspec_sample]$ sudo gem install coderay
```

```arduino
[vagrant@demo serverspec_sample]$ rake spec SPEC_OPTS="--format html" > ~/result.html
/usr/local/rvm/rubies/ruby-2.7.0/bin/ruby -I/usr/local/rvm/rubies/ruby-2.7.0/lib
/ruby/gems/2.7.0/gems/rspec-support-3.9.3/lib:/usr/local/rvm/rubies/ruby-2.7.0/lib
ruby/gems/2.7.0/gems/rspec-core-3.9.2/lib /usr/local/rvm/rubies/ruby-2.7.0/lib/ruby
/gems/2.7.0/gems/rspec-core-3.9.2/exe/rspec --pattern spec/localhost/\*_spec.rb failed
```

```arduino
[vagrant@demo serverspec_sample]$ sudo mv ~/result.html /usr/share/nginx/html/
[vagrant@demo serverspec_sample]$ sudo setenforce 0
[vagrant@demo serverspec_sample]$ sudo systemctl start nginx.service
```

- í˜¸ìŠ¤íŠ¸ PCì—ì„œ [http://192.168.33.10/result.html](http://192.168.33.10/result.html) ìœ¼ë¡œ ì ‘ì† í•´ë´…ë‹ˆë‹¤.
    - ì ‘ì†ì´ ì•ˆë˜ëŠ” ê²½ìš°

```arduino
[vagrant@demo serverspec_sample]$ sudo systemctl stop firewalld
```

- ì ‘ì†í™”ë©´

![Untitled.png](6/Untitled3.png)